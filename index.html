<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>校园饮食预算助手</title>
  <!-- 外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
            neutral: '#64748B'
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .card {
        @apply bg-white rounded-xl shadow-sm p-5 transition-all duration-300 hover:shadow-md;
      }
      .btn {
        @apply py-2 px-4 rounded-lg font-medium transition-all duration-300;
      }
      .btn-primary {
        @apply bg-primary text-white hover:bg-primary/90;
      }
      .btn-secondary {
        @apply bg-secondary text-white hover:bg-secondary/90;
      }
    }
  </style>
</head>

<body class="bg-gray-50 font-sans text-gray-800">
  <!-- 头部 -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center gap-3">
      <h1 class="text-xl font-bold text-primary flex items-center">
        <i class="fa fa-cutlery mr-2"></i>校园饮食预算助手
      </h1>
      <div class="flex gap-3">
        <button id="exportBtn" class="text-primary hover:text-primary/80 flex items-center text-sm">
          <i class="fa fa-download mr-1"></i> 导出数据
        </button>
        <label for="importFile" class="cursor-pointer text-primary hover:text-primary/80 flex items-center text-sm">
          <i class="fa fa-upload mr-1"></i> 导入数据
        </label>
        <input type="file" id="importFile" accept=".json" class="hidden">
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <!-- 预算概览 -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- 总预算 -->
      <div class="card">
        <div class="flex justify-between items-start mb-3">
          <div>
            <p class="text-neutral text-sm">当前预算</p>
            <h3 id="totalBudget" class="text-2xl font-bold">¥0</h3>
          </div>
          <span id="budgetType" class="bg-primary/10 text-primary text-xs px-2 py-1 rounded-full">每日</span>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-2">
          <div id="budgetProgress" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
        </div>
        <div class="flex justify-between mt-2 text-xs text-neutral">
          <span id="usedPercent">0% 已使用</span>
          <span id="budgetPeriod">今日</span>
        </div>
      </div>

      <!-- 已消费 -->
      <div class="card">
        <p class="text-neutral text-sm">已消费</p>
        <h3 id="spentAmount" class="text-2xl font-bold text-warning">¥0</h3>
        <div class="grid grid-cols-3 gap-2 mt-3">
          <div class="bg-gray-50 rounded p-2 text-center text-xs">
            <p class="text-neutral">早餐</p>
            <p id="spentBreakfast" class="font-medium">¥0</p>
          </div>
          <div class="bg-gray-50 rounded p-2 text-center text-xs">
            <p class="text-neutral">午餐</p>
            <p id="spentLunch" class="font-medium">¥0</p>
          </div>
          <div class="bg-gray-50 rounded p-2 text-center text-xs">
            <p class="text-neutral">晚餐</p>
            <p id="spentDinner" class="font-medium">¥0</p>
          </div>
        </div>
      </div>

      <!-- 剩余预算 -->
      <div class="card">
        <p class="text-neutral text-sm">剩余预算</p>
        <h3 id="remainingAmount" class="text-2xl font-bold text-secondary">¥0</h3>
        <div id="budgetWarning" class="mt-3 p-2 bg-danger/10 text-danger text-xs rounded hidden">
          <i class="fa fa-exclamation-circle mr-1"></i> 已使用超过90%预算
        </div>
        <div id="budgetTip" class="mt-3 p-2 bg-primary/10 text-primary text-xs rounded">
          <i class="fa fa-lightbulb-o mr-1"></i> 合理规划饮食支出
        </div>
      </div>
    </section>

    <!-- 主要内容区 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- 左侧：预算设置和快速记录 -->
      <div class="space-y-6">
        <!-- 预算设置 -->
        <div class="card">
          <h2 class="text-lg font-bold mb-4 flex items-center">
            <i class="fa fa-sliders text-primary mr-2"></i>预算设置
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-neutral mb-1">预算周期</label>
              <div class="flex gap-4">
                <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="cycle" value="daily" checked class="text-primary">
                  <span class="ml-1 text-sm">每日</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="cycle" value="weekly" class="text-primary">
                  <span class="ml-1 text-sm">每周</span>
                </label>
              </div>
            </div>
            <div>
              <label for="dailyAmount" class="block text-sm text-neutral mb-1">每日预算 (元)</label>
              <input type="number" id="dailyAmount" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
            </div>
            <div>
              <label for="weeklyAmount" class="block text-sm text-neutral mb-1">每周预算 (元)</label>
              <input type="number" id="weeklyAmount" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
            </div>
            <button id="saveBudgetBtn" class="btn btn-primary w-full">保存设置</button>
          </div>
        </div>

        <!-- 快速记录消费 -->
        <div class="card">
          <h2 class="text-lg font-bold mb-4 flex items-center">
            <i class="fa fa-plus-circle text-primary mr-2"></i>记录消费
          </h2>
          <div class="space-y-4">
            <div>
              <label for="expensePrice" class="block text-sm text-neutral mb-1">金额 (元)</label>
              <input type="number" id="expensePrice" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
            </div>
            <div>
              <label for="expenseType" class="block text-sm text-neutral mb-1">类别</label>
              <select id="expenseType" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
                <option value="breakfast">早餐</option>
                <option value="lunch">午餐</option>
                <option value="dinner">晚餐</option>
                <option value="snack">零食/饮料</option>
              </select>
            </div>
            <div>
              <label for="expenseName" class="block text-sm text-neutral mb-1">名称</label>
              <input type="text" id="expenseName" placeholder="例如：鸡蛋灌饼" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
            </div>
            <button id="addExpenseBtn" class="btn btn-secondary w-full">添加记录</button>
          </div>
        </div>
      </div>

      <!-- 右侧：消费记录和趋势图表 -->
      <div class="lg:col-span-2 space-y-6">
        <!-- 消费记录 -->
        <div class="card">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold flex items-center">
              <i class="fa fa-history text-primary mr-2"></i>消费记录
            </h2>
            <button id="clearRecordsBtn" class="text-danger text-sm hover:underline">清空记录</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="border-b border-gray-100">
                  <th class="text-left py-2 text-neutral">时间</th>
                  <th class="text-left py-2 text-neutral">名称</th>
                  <th class="text-left py-2 text-neutral">类别</th>
                  <th class="text-left py-2 text-neutral">金额</th>
                  <th class="text-left py-2 text-neutral">操作</th>
                </tr>
              </thead>
              <tbody id="recordsTable">
                <tr>
                  <td colspan="5" class="py-6 text-center text-neutral">暂无消费记录</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 统计图表（仅保留趋势图） -->
        <div class="card">
          <h2 class="text-lg font-bold mb-4 flex items-center">
            <i class="fa fa-chart-line text-primary mr-2"></i>消费统计
          </h2>
          <div class="h-64">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-white border-t mt-8 py-4">
    <div class="container mx-auto px-4 text-center text-neutral text-sm">
      <p>数据存储在本地，刷新页面不丢失 | 校园饮食预算助手</p>
    </div>
  </footer>

  <script>
    // 经济实惠的推荐菜品（仅用于预算建议，不显示在页面）
    const cheapDishes = [
      { name: "食堂早餐粥+鸡蛋", price: 5, type: "breakfast" },
      { name: "一食堂素菜包+豆浆", price: 4, type: "breakfast" },
      { name: "二食堂经济套餐", price: 8, type: "lunch" },
      { name: "三食堂汤面", price: 7, type: "dinner" },
      { name: "小卖部矿泉水", price: 2, type: "snack" }
    ];

    // 应用状态
    const state = {
      budget: {
        daily: 25,
        weekly: 150,
        cycle: 'daily'
      },
      records: [],
      charts: {
        trend: null // 仅保留趋势图表
      }
    };

    // DOM元素
    const el = {
      // 预算设置
      cycleRadios: document.querySelectorAll('input[name="cycle"]'),
      dailyAmount: document.getElementById('dailyAmount'),
      weeklyAmount: document.getElementById('weeklyAmount'),
      saveBudgetBtn: document.getElementById('saveBudgetBtn'),
      
      // 消费记录
      expensePrice: document.getElementById('expensePrice'),
      expenseType: document.getElementById('expenseType'),
      expenseName: document.getElementById('expenseName'),
      addExpenseBtn: document.getElementById('addExpenseBtn'),
      recordsTable: document.getElementById('recordsTable'),
      clearRecordsBtn: document.getElementById('clearRecordsBtn'),
      
      // 预算概览
      totalBudget: document.getElementById('totalBudget'),
      spentAmount: document.getElementById('spentAmount'),
      remainingAmount: document.getElementById('remainingAmount'),
      spentBreakfast: document.getElementById('spentBreakfast'),
      spentLunch: document.getElementById('spentLunch'),
      spentDinner: document.getElementById('spentDinner'),
      budgetProgress: document.getElementById('budgetProgress'),
      usedPercent: document.getElementById('usedPercent'),
      budgetType: document.getElementById('budgetType'),
      budgetPeriod: document.getElementById('budgetPeriod'),
      budgetWarning: document.getElementById('budgetWarning'),
      budgetTip: document.getElementById('budgetTip'),
      
      // 其他
      exportBtn: document.getElementById('exportBtn'),
      importFile: document.getElementById('importFile')
    };

    // 初始化应用
    function initApp() {
      loadData();
      renderRecords();
      updateBudgetOverview();
      initCharts();
      bindEvents();
    }

    // 从本地存储加载数据
    function loadData() {
      const savedBudget = localStorage.getItem('foodBudget');
      const savedRecords = localStorage.getItem('foodRecords');
      
      if (savedBudget) {
        state.budget = JSON.parse(savedBudget);
        el.dailyAmount.value = state.budget.daily;
        el.weeklyAmount.value = state.budget.weekly;
        
        // 设置选中的周期
        el.cycleRadios.forEach(radio => {
          if (radio.value === state.budget.cycle) {
            radio.checked = true;
          }
        });
      }
      
      if (savedRecords) {
        state.records = JSON.parse(savedRecords);
      }
    }

    // 保存数据到本地存储
    function saveData() {
      localStorage.setItem('foodBudget', JSON.stringify(state.budget));
      localStorage.setItem('foodRecords', JSON.stringify(state.records));
    }

    // 获取类别中文名称
    function getTypeName(type) {
      const map = {
        breakfast: '早餐',
        lunch: '午餐',
        dinner: '晚餐',
        snack: '零食'
      };
      return map[type] || type;
    }

    // 添加消费记录
    function addRecord(price, type, name) {
      if (!price || price <= 0) {
        alert('请输入有效的金额');
        return;
      }
      
      if (!name) {
        alert('请输入消费名称');
        return;
      }
      
      const now = new Date();
      const record = {
        id: Date.now(),
        date: now.toISOString().split('T')[0],
        time: now.toTimeString().slice(0, 8),
        price: parseFloat(price),
        type,
        name
      };
      
      state.records.unshift(record);
      saveData();
      renderRecords();
      updateBudgetOverview();
      updateCharts();
      
      // 清空输入
      el.expensePrice.value = '';
      el.expenseName.value = '';
    }

    // 渲染消费记录
    function renderRecords() {
      if (state.records.length === 0) {
        el.recordsTable.innerHTML = `
          <tr>
            <td colspan="5" class="py-6 text-center text-neutral">暂无消费记录</td>
          </tr>
        `;
        return;
      }
      
      el.recordsTable.innerHTML = '';
      
      state.records.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-50 hover:bg-gray-50';
        row.innerHTML = `
          <td class="py-3">${record.date} ${record.time}</td>
          <td class="py-3">${record.name}</td>
          <td class="py-3">${getTypeName(record.type)}</td>
          <td class="py-3 font-medium">¥${record.price.toFixed(2)}</td>
          <td class="py-3">
            <button class="text-danger text-xs hover:underline delete-record" data-id="${record.id}">
              删除
            </button>
          </td>
        `;
        
        el.recordsTable.appendChild(row);
      });
      
      // 绑定删除事件
      document.querySelectorAll('.delete-record').forEach(btn => {
        btn.addEventListener('click', e => {
          const id = parseInt(e.target.dataset.id);
          deleteRecord(id);
        });
      });
    }

    // 删除消费记录
    function deleteRecord(id) {
      state.records = state.records.filter(r => r.id !== id);
      saveData();
      renderRecords();
      updateBudgetOverview();
      updateCharts();
    }

    // 清空所有记录
    function clearAllRecords() {
      if (confirm('确定要清空所有消费记录吗？此操作不可恢复。')) {
        state.records = [];
        saveData();
        renderRecords();
        updateBudgetOverview();
        updateCharts();
      }
    }

    // 保存预算设置
    function saveBudget() {
      const daily = parseFloat(el.dailyAmount.value) || 0;
      const weekly = parseFloat(el.weeklyAmount.value) || 0;
      
      if (daily <= 0 && weekly <= 0) {
        alert('请设置有效的预算金额');
        return;
      }
      
      // 获取选中的周期
      let cycle = 'daily';
      el.cycleRadios.forEach(radio => {
        if (radio.checked) {
          cycle = radio.value;
        }
      });
      
      state.budget = { daily, weekly, cycle };
      saveData();
      updateBudgetOverview();
      updateCharts();
      
      alert('预算设置已保存');
    }

    // 计算当前周期的消费情况
    function calculateCurrentSpending() {
      const today = new Date().toISOString().split('T')[0];
      const dayOfWeek = new Date().getDay() || 7; // 转换为1-7
      const weekStart = new Date();
      weekStart.setDate(weekStart.getDate() - (dayOfWeek - 1));
      const weekStartStr = weekStart.toISOString().split('T')[0];
      
      let total = 0;
      let breakfast = 0;
      let lunch = 0;
      let dinner = 0;
      
      state.records.forEach(record => {
        const inCycle = state.budget.cycle === 'daily' 
          ? record.date === today
          : record.date >= weekStartStr && record.date <= today;
          
        if (inCycle) {
          total += record.price;
          if (record.type === 'breakfast') breakfast += record.price;
          else if (record.type === 'lunch') lunch += record.price;
          else if (record.type === 'dinner') dinner += record.price;
        }
      });
      
      return { total, breakfast, lunch, dinner };
    }

    // 更新预算概览
    function updateBudgetOverview() {
      const spending = calculateCurrentSpending();
      const budget = state.budget[state.budget.cycle];
      const remaining = Math.max(0, budget - spending.total);
      const percent = budget > 0 ? (spending.total / budget) * 100 : 0;
      
      // 更新显示
      el.totalBudget.textContent = `¥${budget.toFixed(2)}`;
      el.spentAmount.textContent = `¥${spending.total.toFixed(2)}`;
      el.remainingAmount.textContent = `¥${remaining.toFixed(2)}`;
      
      el.spentBreakfast.textContent = `¥${spending.breakfast.toFixed(2)}`;
      el.spentLunch.textContent = `¥${spending.lunch.toFixed(2)}`;
      el.spentDinner.textContent = `¥${spending.dinner.toFixed(2)}`;
      
      el.budgetProgress.style.width = `${Math.min(100, percent)}%`;
      el.usedPercent.textContent = `${Math.round(percent)}% 已使用`;
      
      // 更新周期显示
      el.budgetType.textContent = state.budget.cycle === 'daily' ? '每日' : '每周';
      el.budgetPeriod.textContent = state.budget.cycle === 'daily' ? '今日' : '本周';
      
      // 预算警告
      if (percent >= 90 && budget > 0) {
        el.budgetWarning.classList.remove('hidden');
      } else {
        el.budgetWarning.classList.add('hidden');
      }
      
      // 更新消费建议
      updateTips(remaining);
    }

    // 更新消费建议
    function updateTips(remaining) {
      if (remaining <= 0) {
        el.budgetTip.innerHTML = '<i class="fa fa-exclamation-triangle mr-1"></i> 预算已用尽，建议控制支出';
        return;
      }
      
      // 找到价格不超过剩余预算的推荐菜品
      const affordable = cheapDishes.filter(d => d.price <= remaining);
      
      if (affordable.length > 0) {
        const random = affordable[Math.floor(Math.random() * affordable.length)];
        el.budgetTip.innerHTML = `<i class="fa fa-lightbulb-o mr-1"></i> 剩余${remaining.toFixed(2)}元，推荐：${random.name}（${random.price}元）`;
      } else {
        el.budgetTip.innerHTML = '<i class="fa fa-info-circle mr-1"></i> 剩余预算较少，建议选择经济实惠的选项';
      }
    }

    // 初始化图表（仅保留趋势图）
    function initCharts() {
      // 趋势图表
      const trendCtx = document.getElementById('trendChart').getContext('2d');
      state.charts.trend = new Chart(trendCtx, {
        type: 'bar',
        data: getTrendData(),
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: '金额 (元)' } }
          }
        }
      });
    }

    // 更新图表数据（仅更新趋势图）
    function updateCharts() {
      state.charts.trend.data = getTrendData();
      state.charts.trend.update();
    }

    // 获取趋势图表数据
    function getTrendData() {
      // 获取过去7天的日期
      const dates = [];
      const labels = [];
      
      for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        dates.push(d.toISOString().split('T')[0]);
        labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
      }
      
      // 计算每天的消费总额
      const dailyTotals = dates.map(date => {
        return state.records
          .filter(r => r.date === date)
          .reduce((sum, r) => sum + r.price, 0);
      });
      
      return {
        labels: labels,
        datasets: [{
          label: '每日消费',
          data: dailyTotals,
          backgroundColor: '#3B82F6',
          borderRadius: 4
        }]
      };
    }

    // 导出数据
    function exportData() {
      const data = {
        budget: state.budget,
        records: state.records,
        exportTime: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `饮食预算数据_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // 导入数据
    function importData(file) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.budget && data.records) {
            state.budget = data.budget;
            state.records = data.records;
            
            // 更新UI
            el.dailyAmount.value = state.budget.daily;
            el.weeklyAmount.value = state.budget.weekly;
            el.cycleRadios.forEach(radio => {
              radio.checked = radio.value === state.budget.cycle;
            });
            
            saveData();
            renderRecords();
            updateBudgetOverview();
            updateCharts();
            
            alert('数据导入成功');
          } else {
            alert('导入的数据格式不正确');
          }
        } catch (err) {
          alert('导入失败：' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // 绑定事件
    function bindEvents() {
      // 保存预算
      el.saveBudgetBtn.addEventListener('click', saveBudget);
      
      // 添加消费记录
      el.addExpenseBtn.addEventListener('click', () => {
        addRecord(
          el.expensePrice.value,
          el.expenseType.value,
          el.expenseName.value
        );
      });
      
      // 清空记录
      el.clearRecordsBtn.addEventListener('click', clearAllRecords);
      
      // 预算周期变更
      el.cycleRadios.forEach(radio => {
        radio.addEventListener('change', updateBudgetOverview);
      });
      
      // 导出数据
      el.exportBtn.addEventListener('click', exportData);
      
      // 导入数据
      el.importFile.addEventListener('change', e => {
        if (e.target.files.length > 0) {
          importData(e.target.files[0]);
          e.target.value = ''; // 允许重复选择同一文件
        }
      });
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
